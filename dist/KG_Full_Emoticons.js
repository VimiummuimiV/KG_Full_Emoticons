// ==UserScript==
// @name         KG_Full_Emoticons
// @namespace    http://klavogonki.ru/
// @version      1.6
// @description  Display a popup panel with every available emoticon on the site, remembering the last selected emoticon per category by name.
// @match        *://klavogonki.ru/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=klavogonki.ru
// @grant        none
// ==/UserScript==

(()=>{"use strict";var e={56:(e,t,o)=>{e.exports=function(e){var t=o.nc;t&&e.setAttribute("nonce",t)}},72:e=>{var t=[];function o(e){for(var o=-1,r=0;r<t.length;r++)if(t[r].identifier===e){o=r;break}return o}function r(e,r){for(var a={},i=[],s=0;s<e.length;s++){var c=e[s],l=r.base?c[0]+r.base:c[0],u=a[l]||0,d="".concat(l," ").concat(u);a[l]=u+1;var p=o(d),m={css:c[1],media:c[2],sourceMap:c[3],supports:c[4],layer:c[5]};if(-1!==p)t[p].references++,t[p].updater(m);else{var g=n(m,r);r.byIndex=s,t.splice(s,0,{identifier:d,updater:g,references:1})}i.push(d)}return i}function n(e,t){var o=t.domAPI(t);o.update(e);return function(t){if(t){if(t.css===e.css&&t.media===e.media&&t.sourceMap===e.sourceMap&&t.supports===e.supports&&t.layer===e.layer)return;o.update(e=t)}else o.remove()}}e.exports=function(e,n){var a=r(e=e||[],n=n||{});return function(e){e=e||[];for(var i=0;i<a.length;i++){var s=o(a[i]);t[s].references--}for(var c=r(e,n),l=0;l<a.length;l++){var u=o(a[l]);0===t[u].references&&(t[u].updater(),t.splice(u,1))}a=c}}},113:e=>{e.exports=function(e,t){if(t.styleSheet)t.styleSheet.cssText=e;else{for(;t.firstChild;)t.removeChild(t.firstChild);t.appendChild(document.createTextNode(e))}}},314:e=>{e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var o="",r=void 0!==t[5];return t[4]&&(o+="@supports (".concat(t[4],") {")),t[2]&&(o+="@media ".concat(t[2]," {")),r&&(o+="@layer".concat(t[5].length>0?" ".concat(t[5]):""," {")),o+=e(t),r&&(o+="}"),t[2]&&(o+="}"),t[4]&&(o+="}"),o})).join("")},t.i=function(e,o,r,n,a){"string"==typeof e&&(e=[[null,e,void 0]]);var i={};if(r)for(var s=0;s<this.length;s++){var c=this[s][0];null!=c&&(i[c]=!0)}for(var l=0;l<e.length;l++){var u=[].concat(e[l]);r&&i[u[0]]||(void 0!==a&&(void 0===u[5]||(u[1]="@layer".concat(u[5].length>0?" ".concat(u[5]):""," {").concat(u[1],"}")),u[5]=a),o&&(u[2]?(u[1]="@media ".concat(u[2]," {").concat(u[1],"}"),u[2]=o):u[2]=o),n&&(u[4]?(u[1]="@supports (".concat(u[4],") {").concat(u[1],"}"),u[4]=n):u[4]="".concat(n)),t.push(u))}},t}},540:e=>{e.exports=function(e){var t=document.createElement("style");return e.setAttributes(t,e.attributes),e.insert(t,e.options),t}},601:e=>{e.exports=function(e){return e[1]}},659:e=>{var t={};e.exports=function(e,o){var r=function(e){if(void 0===t[e]){var o=document.querySelector(e);if(window.HTMLIFrameElement&&o instanceof window.HTMLIFrameElement)try{o=o.contentDocument.head}catch(e){o=null}t[e]=o}return t[e]}(e);if(!r)throw new Error("Couldn't find a style target. This probably means that the value for the 'insert' parameter is invalid.");r.appendChild(o)}},825:e=>{e.exports=function(e){if("undefined"==typeof document)return{update:function(){},remove:function(){}};var t=e.insertStyleElement(e);return{update:function(o){!function(e,t,o){var r="";o.supports&&(r+="@supports (".concat(o.supports,") {")),o.media&&(r+="@media ".concat(o.media," {"));var n=void 0!==o.layer;n&&(r+="@layer".concat(o.layer.length>0?" ".concat(o.layer):""," {")),r+=o.css,n&&(r+="}"),o.media&&(r+="}"),o.supports&&(r+="}");var a=o.sourceMap;a&&"undefined"!=typeof btoa&&(r+="\n/*# sourceMappingURL=data:application/json;base64,".concat(btoa(unescape(encodeURIComponent(JSON.stringify(a))))," */")),t.styleTagTransform(r,e,t.options)}(t,e,o)},remove:function(){!function(e){if(null===e.parentNode)return!1;e.parentNode.removeChild(e)}(t)}}}},911:(e,t,o)=>{o.d(t,{A:()=>s});var r=o(601),n=o.n(r),a=o(314),i=o.n(a)()(n());i.push([e.id,"",""]);const s=i}},t={};function o(r){var n=t[r];if(void 0!==n)return n.exports;var a=t[r]={id:r,exports:{}};return e[r](a,a.exports,o),a.exports}o.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return o.d(t,{a:t}),t},o.d=(e,t)=>{for(var r in t)o.o(t,r)&&!o.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.nc=void 0;var r=o(72),n=o.n(r),a=o(825),i=o.n(a),s=o(659),c=o.n(s),l=o(56),u=o.n(l),d=o(540),p=o.n(d),m=o(113),g=o.n(m),y=o(911),f={};f.styleTagTransform=g(),f.setAttributes=u(),f.insert=c().bind(null,"head"),f.domAPI=i(),f.insertStyleElement=p();n()(y.A,f);y.A&&y.A.locals&&y.A.locals;const v={Boys:["hello","hi","smile","wink","biggrin","laugh","happy","cool","rofl","rofl2","rolleyes","spiteful","crazy","acute","silence","tongue","whistle","music","ph34r","excl","no","yes","ok","bye","victory","good","clapping","dance","cult","power","boystroking","complaugh","badcomp","gamer","first","second","third","formula1","friends","popcorn","tea","beer","grats","birthday","holmes","kidtruck","musketeer","pioneer","mellow","dry","sleep","cry","sick","sorry","unsure","boredom","facepalm","scare","blink","sad","confuse","nervous","wacko","huh","ohmy","megashok","shok","bad","russian","dash","angry","angry2"],Girls:["cheerful","cheerleader","clapgirl","curtsey","enjoygift","girlblum","girlconfuse","girlcrazy","girlcry","girlicecream","girlimpossible","girlinlove","girlkiss","girlkissboy","girlmad","girlmusic","girlnervous","girlnotebook","girlobserve","girlrevolve","girlsad","umbrage","girlscare","girlshighfive","girlsick","girlsilence","girlstop","girlstroking","girlsuper","girltea","girlwacko","girlwink","girlwitch","girlwonder","goody","hairdryer","hiya","hysteric","kgagainstaz","kgrace","primp","respect","spruceup","spruceup1","supergirl","tender","angrygirl","girldevil"],Christmas:["firework","confetti","cheers","wine","champ","champ2","santa","santa2","santa3","snowhand","snowhit","heyfrombag","snowgirlwave","snowball","snegurochka","santasnegurka","snowman","merrychristmas","spruce","moose","christmasevil"],Inlove:["inlove","hug","boykiss","wecheers","wedance","adultery","cave","leisure","wedding","airkiss","kissed","flowers","grose","flowers2","rose","smell","frog","girlfrog","rocker","serenade","val","girlval","bemine","heartcake","heart2","girlheart2","girllove","nolove","heart","blush","wub"],Army:["uzi","ak47","barret","chaingun","pogranminigun","partizan","dandy","gangster","mafia","foolrifle","cowboy","armyscare","armystar","armyfriends","armytongue","soldier","bayanist","pogranmail","pogran","pogranflowers","pogranrose","pograntort","girlpogran","pogranmama","budenov","captain","vdv","comandos","kirpich","girlvdv","girlranker","ranker","girlrogatka","rogatka","radistka","prival","vtik","vpered","tank","fly"],Halloween:["alien","ghost","cyborg","robot","terminator","turtle","batman","bebebe","bite","corsair","girlpirate","indigenous","clown","jester","death","paladin","pirate","dwarf","pirates","witch","wizard","spider","diablo","vampire","carpet"],Favourites:[]},h={Boys:"üòÉ",Girls:"üë©‚Äçü¶∞",Christmas:"üéÑ",Inlove:"‚ù§Ô∏è",Army:"üî´",Halloween:"üéÉ",Favourites:"üåü"};!function(){const e={eventListeners:[],activeCategory:localStorage.getItem("activeCategory")||"Boys",isPopupCreated:!1,categoryHistory:[],currentSortedEmoticons:[],lastFocusedInput:null,latestCategoryRequest:null,lastKeyTimes:{},lastUsedEmoticons:JSON.parse(localStorage.getItem("lastUsedEmoticons"))||{}};const t="0.2em",o="0 8px 30px rgba(0, 0, 0, 0.12), 0 4px 6px rgba(0, 0, 0, 0.04), 0 2px 2px rgba(0, 0, 0, 0.08)",r=function(e){const t=e.match(/\d+/g);if(t&&3===t.length){const[e,o,r]=t.map(Number),n=Math.max(e,o,r)/255,a=Math.min(e,o,r)/255;return Math.round((n+a)/2*100)}return 0}(window.getComputedStyle(document.body).backgroundColor),n={popupBackground:a("popupBackground"),defaultButton:a("defaultButton"),hoverButton:a("hoverButton"),activeButton:a("activeButton"),selectedButton:a("selectedButton")};function a(e){const t={popupBackground:10,defaultButton:15,hoverButton:25,activeButton:35,selectedButton:45}[e]||0;return`hsl(0, 0%, ${r<50?r+t:r-t}%)`}function i(){return JSON.parse(localStorage.getItem("emoticonUsageData"))||{}}function s(t){const o=i();o[e.activeCategory]=o[e.activeCategory]||{},o[e.activeCategory][t]=(o[e.activeCategory][t]||0)+1,function(e){localStorage.setItem("emoticonUsageData",JSON.stringify(e))}(o)}function c(e){const t=i()[e]||{};return v[e].slice().sort(((e,o)=>(t[o]||0)-(t[e]||0)))}function l(e){return(JSON.parse(localStorage.getItem("favoriteEmoticons"))||[]).includes(e)}function u(){const e=window.location.pathname,t=window.location.hash,o=new URLSearchParams(window.location.search).get("gmid"),r=t.match(/#\/(\d+)\//);return{isForum:e.includes("/forum/"),isGamelist:e.includes("/gamelist/"),isGame:!!o,isProfile:"/u/"===e&&!!r,gmid:o||null,profileId:r?.[1]||null}}function d(e){!document.querySelector(".emoticons-popup")||"Escape"!==e.code&&"KeyQ"!==e.code||(e.preventDefault(),y())}function p(e){const t=document.querySelector(".emoticons-popup");t&&!t.contains(e.target)&&y()}function m(t){const o=u();let r=e.lastFocusedInput;if(!r){if(o.isForum?r=document.getElementById("fast-reply_textarea"):o.isGamelist?r=document.querySelector("#chat-general.chat .messages input.text"):o.isGame&&(r=document.querySelector('[id^="chat-game"].chat .messages input.text')),!r){const e={isForum:"the forum",isProfile:"the profile",isGamelist:"general chat",isGame:"game chat"},t=Object.entries(e).filter((([e])=>o[e])).map((([e,t])=>t)).join(", ");return void alert(`Please focus on a text field in ${t}.`)}r.focus(),e.lastFocusedInput=r}const n=function(t){const{isForum:o}=u();return o&&e.lastFocusedInput&&"textarea"===e.lastFocusedInput.tagName.toLowerCase()?`[img]https://klavogonki.ru/img/smilies/${t}.gif[/img] `:`:${t}: `}(t),a=r.selectionStart||0;r.value=r.value.slice(0,a)+n+r.value.slice(a),r.setSelectionRange(a+n.length,a+n.length),r.focus()}function g(e,t){"show"===t?(document.body.appendChild(e),requestAnimationFrame((()=>{e.style.opacity="1"}))):(e.style.opacity="0",setTimeout((()=>e.remove()),300))}function y(){const t=document.querySelector(".emoticons-popup");t&&(e.eventListeners.forEach((({event:e,handler:t})=>{document.removeEventListener(e,t)})),e.eventListeners=[],g(t,"hide"),e.isPopupCreated=!1)}function f(){e.isPopupCreated?y():setTimeout((()=>{!function(r){if(e.isPopupCreated)return;v.Favourites=JSON.parse(localStorage.getItem("favoriteEmoticons"))||[];const a=document.createElement("div");a.className="emoticons-popup",a.style.setProperty("border-radius","0.4em","important"),a.style.setProperty("box-shadow",o,"important"),Object.assign(a.style,{opacity:"0",transition:"opacity 0.3s cubic-bezier(0.25, 0.8, 0.25, 1)",position:"fixed",display:"grid",gridTemplateRows:"50px auto",gap:"10px",backgroundColor:n.popupBackground,padding:"10px",zIndex:"2000",top:"20vh",left:"50vw",transform:"translateX(-50%)",maxWidth:"50vw",minWidth:"300px",width:"50vw",maxHeight:"50vh",overflow:"hidden"});const i=document.createElement("div");i.classList.add("header-buttons"),Object.assign(i.style,{display:"flex",flexDirection:"row",justifyContent:"space-between"});const s=(e,o,r,n,a)=>{const i=document.createElement("button");return i.classList.add(e),i.title=o,i.innerHTML=r,i.style.setProperty("border-radius",t,"important"),Object.assign(i.style,{border:"none",background:n,cursor:"pointer",boxSizing:"border-box",width:"50px",height:"50px",margin:"0 5px",fontSize:"1.4em"}),a&&i.addEventListener("click",a),i},c=s("clear-button","Clear usage data","üóëÔ∏è","hsl(40deg 50% 15%)",(()=>{confirm("Clear emoticon usage data?")&&localStorage.removeItem("emoticonUsageData")})),l=s("close-button","Close emoticons panel (or press 'q')","‚ùå","hsl(0deg 50% 15%)",y);i.appendChild(c),i.appendChild(function(){const o=document.createElement("div");o.className="category-buttons",Object.assign(o.style,{display:"flex",justifyContent:"center"});for(let r in v)if(Object.prototype.hasOwnProperty.call(v,r)){const a=document.createElement("button");a.classList.add("category-button"),a.innerHTML=h[r],a.dataset.category=r,a.title=r,a.style.setProperty("border-radius",t,"important"),Object.assign(a.style,{background:r===e.activeCategory?n.activeButton:n.defaultButton,border:"none",cursor:"pointer",width:"50px",height:"50px",fontSize:"1.4em",margin:"0 5px"}),"Favourites"===r&&(0===v.Favourites.length&&(a.style.opacity="0.5",a.style.pointerEvents="none"),a.addEventListener("click",E)),a.addEventListener("click",(e=>b(r,e))),a.addEventListener("mouseout",(()=>w(a,r))),a.addEventListener("mouseover",(()=>{a.style.background=n.hoverButton})),o.appendChild(a)}return o}()),i.appendChild(l),a.appendChild(i),S(r).then((e=>{a.appendChild(e),requestAnimationFrame(I)})),a.addEventListener("dblclick",y);[{event:"keydown",handler:B},{event:"keydown",handler:L},{event:"keydown",handler:d},{event:"click",handler:p}].forEach((({event:t,handler:o})=>{e.eventListeners.push({event:t,handler:o}),document.addEventListener(t,o)})),document.body.appendChild(a),g(a,"show"),e.isPopupCreated=!0}(e.activeCategory)}),10)}function b(e,t){t.shiftKey||t.ctrlKey||C(e)}function w(t,o){t.style.background=o===e.activeCategory?n.activeButton:n.defaultButton,"Favourites"===o&&(t.style.opacity=v.Favourites.length?"":"0.5")}function E(t){t.ctrlKey&&(localStorage.removeItem("favoriteEmoticons"),v.Favourites=[],I(),e.categoryHistory.length&&(e.activeCategory=e.categoryHistory.pop(),localStorage.setItem("activeCategory",e.activeCategory),k(e.activeCategory),x()))}function k(e){document.querySelectorAll(".category-buttons button").forEach((t=>{t.style.background=t.dataset.category===e?n.activeButton:n.defaultButton,"Favourites"===t.dataset.category&&(0===v.Favourites.length?(t.style.opacity="0.5",t.style.pointerEvents="none"):(t.style.removeProperty("opacity"),t.style.removeProperty("pointer-events")))}))}function C(t){"Favourites"===t&&0===v.Favourites.length||("Favourites"!==e.activeCategory&&e.categoryHistory.push(e.activeCategory),e.activeCategory=t,localStorage.setItem("activeCategory",e.activeCategory),e.currentSortedEmoticons=c(e.activeCategory),k(e.activeCategory),x())}async function S(o){const r=document.createElement("div");r.className="emoticon-buttons",e.currentSortedEmoticons=c(o);const a=[];e.currentSortedEmoticons.forEach((i=>{const c=document.createElement("button");c.classList.add("emoticon-button");const u=`/img/smilies/${i}.gif`;c.innerHTML=`<img src="${u}" alt="${i}">`,c.title=i,c.style.setProperty("border-radius",t,"important"),Object.assign(c.style,{position:"relative",border:"none",cursor:"pointer",filter:i===e.lastUsedEmoticons[e.activeCategory]?"sepia(0.7)":"none",background:i===e.lastUsedEmoticons[e.activeCategory]?n.selectedButton:n.defaultButton}),a.push(new Promise((e=>{const t=new Image;t.onload=e,t.src=u}))),c.addEventListener("mouseover",(()=>{c.style.background=n.hoverButton})),c.addEventListener("mouseout",(()=>{i===e.lastUsedEmoticons[e.activeCategory]?c.style.background=n.selectedButton:"Favourites"!==e.activeCategory&&l(i)?c.style.background=n.activeButton:c.style.background=n.defaultButton})),c.addEventListener("click",(t=>{if(t.stopPropagation(),t.shiftKey)m(i);else if(t.ctrlKey){const e=JSON.parse(localStorage.getItem("favoriteEmoticons"))||[],t=e.indexOf(i);"Favourites"===o&&-1!==t?(e.splice(t,1),v.Favourites.splice(t,1)):"Favourites"===o||e.includes(i)||(e.push(i),v.Favourites.push(i)),localStorage.setItem("favoriteEmoticons",JSON.stringify(e)),k(o),"Favourites"===o&&x()}else m(i),s(i),e.lastUsedEmoticons[e.activeCategory]=i,localStorage.setItem("lastUsedEmoticons",JSON.stringify(e.lastUsedEmoticons)),y();I()})),r.appendChild(c)})),await Promise.all(a);const{maxImageWidth:i,maxImageHeight:u}=await async function(e){const t=34,o=await Promise.all(e.map((e=>new Promise((t=>{const o=new Image;o.onload=()=>t({width:o.width,height:o.height}),o.src=`/img/smilies/${e}.gif`}))))),r=Math.max(t,...o.map((e=>e.width))),n=Math.max(t,...o.map((e=>e.height)));return{maxImageWidth:r,maxImageHeight:n}}(e.currentSortedEmoticons);return Object.assign(r.style,{display:"grid",gap:"10px",scrollbarWidth:"none",overflowY:"auto",overflowX:"hidden",maxHeight:"calc(-80px + 50vh)",gridTemplateColumns:`repeat(auto-fit, minmax(${i}px, 1fr))`,gridAutoRows:`minmax(${u}px, auto)`}),r}function x(){const t=Date.now();e.latestCategoryRequest=t,document.querySelectorAll(".emoticon-buttons").forEach((e=>e.remove())),S(e.activeCategory).then((o=>{if(e.latestCategoryRequest!==t)return;const r=document.querySelector(".emoticons-popup");r&&(r.appendChild(o),I())}))}function I(){requestAnimationFrame((()=>{document.querySelectorAll(".emoticon-buttons button").forEach((t=>{const o=t.title;o===e.lastUsedEmoticons[e.activeCategory]?(t.style.background=n.selectedButton,t.style.filter="sepia(0.7)"):(t.style.filter="none","Favourites"!==e.activeCategory&&l(o)?t.style.background=n.activeButton:t.style.background=n.defaultButton)}))}))}function F(t){const o=e.currentSortedEmoticons.indexOf(e.lastUsedEmoticons[e.activeCategory]);let r=-1===o?0:o+t;r<0&&(r=e.currentSortedEmoticons.length-1),r>=e.currentSortedEmoticons.length&&(r=0),e.lastUsedEmoticons[e.activeCategory]=e.currentSortedEmoticons[r],localStorage.setItem("lastUsedEmoticons",JSON.stringify(e.lastUsedEmoticons)),I()}function B(t){if(!document.querySelector(".emoticons-popup")||!e.currentSortedEmoticons||0===e.currentSortedEmoticons.length)return;if(new Set(["Enter","Semicolon","ArrowLeft","KeyJ","ArrowRight","KeyK"]).has(t.code))if(t.preventDefault(),"Enter"===t.code||"Semicolon"===t.code){const o=e.lastUsedEmoticons[e.activeCategory];o&&e.currentSortedEmoticons.includes(o)&&(m(o),s(o),t.shiftKey||y())}else"ArrowLeft"===t.code||"KeyJ"===t.code?F(-1):"ArrowRight"!==t.code&&"KeyK"!==t.code||F(1)}function L(t){if(!document.querySelector(".emoticons-popup")||!["Tab","KeyH","KeyL"].includes(t.code)&&("Tab"!==t.code||!t.shiftKey))return;t.preventDefault();const o=Object.keys(v),r=0===(JSON.parse(localStorage.getItem("favoriteEmoticons"))||[]).length?o.filter((e=>"Favourites"!==e)):o;let n=r.indexOf(e.activeCategory);-1===n&&(n=0);let a=("Tab"===t.code&&!t.shiftKey||"KeyL"===t.code)&&n<r.length-1?n+1:("KeyH"===t.code||"Tab"===t.code&&t.shiftKey)&&n>0?n-1:n;if(a===n)return;const i=r[a];e.currentSortedEmoticons=c(i),localStorage.setItem("activeCategory",i),C(i)}Object.keys(v).forEach((t=>{Object.prototype.hasOwnProperty.call(e.lastUsedEmoticons,t)&&v[t].includes(e.lastUsedEmoticons[t])||(e.lastUsedEmoticons[t]=v[t][0]||"")})),document.addEventListener("focusin",(function(t){t.target.matches("textarea, input.text, input#message-input")&&(e.lastFocusedInput=t.target)})),document.addEventListener("mouseup",(function(e){e.ctrlKey&&0===e.button&&e.target.matches("textarea, input.text, input#message-input")&&(e.preventDefault(),f())})),document.addEventListener("keydown",(function(t){if("KeyV"===t.code&&t.ctrlKey){document.querySelector(".emoticons-popup")&&y()}else"KeyQ"===t.code?function(t,o,r,n){const a=Date.now();t.code===o?a-(e.lastKeyTimes[o]||0)<r?(t.preventDefault(),n(),e.lastKeyTimes[o]=0):e.lastKeyTimes[o]=a:e.lastKeyTimes[o]=0}(t,"KeyQ",500,(function(){if(e.lastFocusedInput){let t=e.lastFocusedInput.value;t.length>=2&&t.slice(-1)===t.slice(-2,-1)?t=t.slice(0,-2):t.length>=1&&(t=t.slice(0,-1)),e.lastFocusedInput.value=t;const o=t.length;e.lastFocusedInput.setSelectionRange(o,o)}f()})):e.lastKeyTimes.KeyQ=0}))}()})();